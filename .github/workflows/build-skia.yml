name: Build Skia
run-name: Build Skia
on:
  # push:
  workflow_dispatch:
    inputs:
      skia_branch:
        description: 'Skia branch to build (e.g., chrome/m144)'
        required: false
        type: string
        default: 'chrome/m144'
      test_mode:
        description: 'Run in test mode (skip Skia build)'
        required: false
        type: boolean
        default: false

jobs:
  build-skia:
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            platform: wasm
            variant: cpu
            arch: ""
          - os: ubuntu-latest
            platform: wasm
            variant: gpu
            arch: ""
          - os: ubuntu-24.04
            platform: linux
            variant: cpu
            arch: x64
          - os: ubuntu-24.04
            platform: linux
            variant: gpu
            arch: x64
          - os: ubuntu-24.04-arm
            platform: linux
            variant: cpu
            arch: arm64
          - os: ubuntu-24.04-arm
            platform: linux
            variant: gpu
            arch: arm64
          - os: macos-latest
            platform: mac
            variant: cpu
            arch: ""
          - os: macos-latest
            platform: mac
            variant: gpu
            arch: ""
          - os: macos-latest
            platform: ios
            variant: cpu
            arch: ""
          - os: macos-latest
            platform: ios
            variant: gpu
            arch: ""
          - os: windows-latest
            platform: win
            variant: cpu
            arch: x64
          - os: windows-latest
            platform: win
            variant: gpu
            arch: x64
          - os: windows-11-arm
            platform: win
            variant: cpu
            arch: arm64
          - os: windows-11-arm
            platform: win
            variant: gpu
            arch: arm64
    runs-on: ${{ matrix.os }}
    env:
      SKIA_BRANCH: ${{ inputs.skia_branch || 'chrome/m144' }}
    outputs:
      skia_branch: ${{ env.SKIA_BRANCH }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Free disk space (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /opt/hostedtoolcache/CodeQL
          sudo docker image prune --all --force

      - name: Install Linux build dependencies
        if: matrix.platform == 'linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y libfontconfig1-dev libgl1-mesa-dev libglu1-mesa-dev libx11-xcb-dev libxcb1-dev libxcb-xkb-dev ninja-build

      - name: Set up Ninja
        if: ${{ matrix.os != 'ubuntu-24.04-arm' }}
        uses: seanmiddleditch/gha-setup-ninja@v5

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Set Git default branch
        run: git config --global init.defaultBranch main

      - name: Install LLVM and Clang
        if: ${{ runner.os != 'macOS' && matrix.os != 'windows-11-arm' }}
        uses: KyleMayes/install-llvm-action@v2
        with:
          version: "19.1.0"
          env: true

      - name: Install LLVM and Clang (Windows ARM64)
        if: matrix.os == 'windows-11-arm'
        shell: pwsh
        run: |
          $llvmUrl = "https://github.com/llvm/llvm-project/releases/download/llvmorg-19.1.0/LLVM-19.1.0-woa64.exe"
          $installerPath = "$env:TEMP\llvm-installer.exe"
          Write-Host "Downloading LLVM installer..."
          Invoke-WebRequest -Uri $llvmUrl -OutFile $installerPath
          Write-Host "Installing LLVM silently..."
          Start-Process -FilePath $installerPath -ArgumentList "/S" -Wait
          Write-Host "LLVM installed successfully"
          # Add LLVM to PATH
          echo "C:\Program Files\LLVM\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      - name: Cache depot_tools and Skia source
        uses: actions/cache@v4
        with:
          path: |
            build/tmp/depot_tools
            build/src/skia
          key: ${{ runner.os }}-${{ matrix.arch || 'default' }}-depot_tools-skia-${{ env.SKIA_BRANCH }}-${{ hashFiles('build-skia.py') }}

      # - name: Build Skia (Debug)
      #   if: ${{ !inputs.test_mode }}
      #   run: |
      #     python3 build-skia.py ${{ matrix.platform }} -config Debug --shallow -branch ${{ env.SKIA_BRANCH }}

      - name: Build Skia (Release)
        if: ${{ !inputs.test_mode }}
        shell: bash
        run: |
          ARCH_ARG=""
          if [ -n "${{ matrix.arch }}" ]; then
            ARCH_ARG="-archs ${{ matrix.arch }}"
          fi
          python3 build-skia.py ${{ matrix.platform }} -variant ${{ matrix.variant }} -config Release --shallow -branch ${{ env.SKIA_BRANCH }} $ARCH_ARG

      - name: Set archive name
        id: archive
        shell: bash
        run: |
          if [ -n "${{ matrix.arch }}" ]; then
            echo "name=skia-build-${{ matrix.platform }}-${{ matrix.arch }}-${{ matrix.variant }}" >> $GITHUB_OUTPUT
          else
            echo "name=skia-build-${{ matrix.platform }}-${{ matrix.variant }}" >> $GITHUB_OUTPUT
          fi

      - name: Create dummy files for test mode
        if: ${{ inputs.test_mode }}
        shell: bash
        run: |
          mkdir -p build/include
          mkdir -p build/${{ matrix.platform }}-${{ matrix.variant }}
          echo "Test file" > build/include/test.h
          echo "Test lib" > build/${{ matrix.platform }}-${{ matrix.variant }}/test.lib
          echo "GN args summary" > build/${{ matrix.platform }}-${{ matrix.variant }}/gn_args.txt

      - name: Package binaries
        shell: bash
        run: |
          if [ "${{ runner.os }}" == "Windows" ]; then
            7z a -tzip ${{ steps.archive.outputs.name }}.zip build/include build/${{ matrix.platform }}-${{ matrix.variant }}
          else
            zip -r ${{ steps.archive.outputs.name }}.zip build/include build/${{ matrix.platform }}-${{ matrix.variant }}
          fi

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.archive.outputs.name }}
          path: ${{ steps.archive.outputs.name }}.zip

      - name: Set SKIA_BRANCH output
        shell: bash
        run: echo "skia_branch=${{ env.SKIA_BRANCH }}" >> $GITHUB_OUTPUT

  create-release:
    needs: build-skia
    runs-on: ubuntu-latest
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          body: |
            https://raw.githubusercontent.com/google/skia/${{ needs.build-skia.outputs.skia_branch }}/RELEASE_NOTES.md
          tag_name: ${{ needs.build-skia.outputs.skia_branch }}${{ inputs.test_mode && '-test' || '' }}
          name: ${{ needs.build-skia.outputs.skia_branch }}${{ inputs.test_mode && ' (Test)' || '' }}
          draft: false
          prerelease: ${{ inputs.test_mode }}
          files: |
            ./skia-build-wasm-cpu/skia-build-wasm-cpu.zip
            ./skia-build-wasm-gpu/skia-build-wasm-gpu.zip
            ./skia-build-linux-x64-cpu/skia-build-linux-x64-cpu.zip
            ./skia-build-linux-x64-gpu/skia-build-linux-x64-gpu.zip
            ./skia-build-linux-arm64-cpu/skia-build-linux-arm64-cpu.zip
            ./skia-build-linux-arm64-gpu/skia-build-linux-arm64-gpu.zip
            ./skia-build-ios-cpu/skia-build-ios-cpu.zip
            ./skia-build-ios-gpu/skia-build-ios-gpu.zip
            ./skia-build-win-x64-cpu/skia-build-win-x64-cpu.zip
            ./skia-build-win-x64-gpu/skia-build-win-x64-gpu.zip
            ./skia-build-win-arm64-cpu/skia-build-win-arm64-cpu.zip
            ./skia-build-win-arm64-gpu/skia-build-win-arm64-gpu.zip
            ./skia-build-mac-cpu/skia-build-mac-cpu.zip
            ./skia-build-mac-gpu/skia-build-mac-gpu.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
