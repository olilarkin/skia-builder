name: Build Skia
run-name: Build Skia
on:
  # push:
  workflow_dispatch:
    inputs:
      test_mode:
        description: 'Run in test mode (skip Skia build)'
        required: false
        type: boolean
        default: false

jobs:
  build-skia:
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            platform: wasm
            variant: cpu
          - os: ubuntu-latest
            platform: wasm
            variant: gpu
          - os: ubuntu-latest
            platform: linux
            variant: cpu
          - os: ubuntu-latest
            platform: linux
            variant: gpu
          - os: macos-latest
            platform: mac
            variant: cpu
          - os: macos-latest
            platform: mac
            variant: gpu
          - os: macos-latest
            platform: ios
            variant: cpu
          - os: macos-latest
            platform: ios
            variant: gpu
          - os: windows-latest
            platform: win
            variant: cpu
            archs: x64
          - os: windows-latest
            platform: win
            variant: gpu
            archs: x64
          - os: windows-latest
            platform: win
            variant: cpu
            archs: arm64
          - os: windows-latest
            platform: win
            variant: gpu
            archs: arm64
          - os: windows-latest
            platform: win
            variant: cpu
            archs: arm64ec
          - os: windows-latest
            platform: win
            variant: gpu
            archs: arm64ec
    runs-on: ${{ matrix.os }}
    env:
      SKIA_BRANCH: chrome/m144
    outputs:
      skia_branch: ${{ env.SKIA_BRANCH }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Free disk space (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /opt/hostedtoolcache/CodeQL
          sudo docker image prune --all --force

      - name: Install Linux build dependencies
        if: matrix.platform == 'linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y libfontconfig1-dev libgl1-mesa-dev libglu1-mesa-dev libx11-xcb-dev libxcb1-dev libxcb-xkb-dev

      - name: Set up Ninja
        uses: seanmiddleditch/gha-setup-ninja@v5

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install LLVM and Clang
        uses: KyleMayes/install-llvm-action@v2
        with:
          version: "20.1.0"
          env: true
  
      - name: Set Git default branch
        run: git config --global init.defaultBranch main

      - name: Cache depot_tools and Skia source
        uses: actions/cache@v4
        with:
          path: |
            build/tmp/depot_tools
            build/src/skia
          key: ${{ runner.os }}-depot_tools-skia-${{ env.SKIA_BRANCH }}-${{ hashFiles('build-skia.py') }}

      # - name: Build Skia (Debug)
      #   if: ${{ !inputs.test_mode }}
      #   run: |
      #     python3 build-skia.py ${{ matrix.platform }} -config Debug --shallow -branch ${{ env.SKIA_BRANCH }}
  
      - name: Build Skia (Release)
        if: ${{ !inputs.test_mode }}
        run: |
          python3 build-skia.py ${{ matrix.platform }} -variant ${{ matrix.variant }} -config Release --shallow -branch ${{ env.SKIA_BRANCH }} ${{ matrix.archs && format('-archs {0}', matrix.archs) || '' }}
  
      - name: Create dummy files for test mode
        if: ${{ inputs.test_mode }}
        shell: bash
        run: |
          ARTIFACT_SUFFIX="${{ matrix.platform }}-${{ matrix.variant }}${{ matrix.archs && format('-{0}', matrix.archs) || '' }}"
          mkdir -p build/include
          mkdir -p build/${ARTIFACT_SUFFIX}
          echo "Test file" > build/include/test.h
          echo "Test lib" > build/${ARTIFACT_SUFFIX}/test.lib
          echo "GN args summary" > build/${ARTIFACT_SUFFIX}/gn_args.txt

      - name: Package binaries
        shell: bash
        run: |
          ARTIFACT_SUFFIX="${{ matrix.platform }}-${{ matrix.variant }}${{ matrix.archs && format('-{0}', matrix.archs) || '' }}"
          PLATFORM_DIR="build/${{ matrix.platform }}-${{ matrix.variant }}"

          # For Windows, the libs are in a subdirectory per architecture
          if [ "${{ runner.os }}" == "Windows" ]; then
            # Create a clean artifact directory with the architecture-specific libs
            ARTIFACT_DIR="build/${ARTIFACT_SUFFIX}"
            mkdir -p "${ARTIFACT_DIR}/lib"
            cp -r "${PLATFORM_DIR}/lib/Release/${{ matrix.archs }}" "${ARTIFACT_DIR}/lib/"
            # Copy gn_args.txt if it exists
            if [ -f "${PLATFORM_DIR}/gn_args.txt" ]; then
              cp "${PLATFORM_DIR}/gn_args.txt" "${ARTIFACT_DIR}/"
            fi
            7z a -tzip skia-build-${ARTIFACT_SUFFIX}.zip build/include ${ARTIFACT_DIR}
          else
            zip -r skia-build-${ARTIFACT_SUFFIX}.zip build/include ${PLATFORM_DIR}
          fi

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: skia-build-${{ matrix.platform }}-${{ matrix.variant }}${{ matrix.archs && format('-{0}', matrix.archs) || '' }}
          path: skia-build-${{ matrix.platform }}-${{ matrix.variant }}${{ matrix.archs && format('-{0}', matrix.archs) || '' }}.zip

      - name: Set SKIA_BRANCH output
        run: echo "skia_branch=${{ env.SKIA_BRANCH }}" >> $GITHUB_OUTPUT

  create-release:
    needs: build-skia
    runs-on: ubuntu-latest
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          body: |
            https://raw.githubusercontent.com/google/skia/${{ needs.build-skia.outputs.skia_branch }}/RELEASE_NOTES.md
          tag_name: ${{ needs.build-skia.outputs.skia_branch }}${{ inputs.test_mode && '-test' || '' }}
          name: ${{ needs.build-skia.outputs.skia_branch }}${{ inputs.test_mode && ' (Test)' || '' }}
          draft: false
          prerelease: ${{ inputs.test_mode }}
          files: |
            ./skia-build-wasm-cpu/skia-build-wasm-cpu.zip
            ./skia-build-wasm-gpu/skia-build-wasm-gpu.zip
            ./skia-build-linux-cpu/skia-build-linux-cpu.zip
            ./skia-build-linux-gpu/skia-build-linux-gpu.zip
            ./skia-build-ios-cpu/skia-build-ios-cpu.zip
            ./skia-build-ios-gpu/skia-build-ios-gpu.zip
            ./skia-build-win-cpu-x64/skia-build-win-cpu-x64.zip
            ./skia-build-win-gpu-x64/skia-build-win-gpu-x64.zip
            ./skia-build-win-cpu-arm64/skia-build-win-cpu-arm64.zip
            ./skia-build-win-gpu-arm64/skia-build-win-gpu-arm64.zip
            ./skia-build-win-cpu-arm64ec/skia-build-win-cpu-arm64ec.zip
            ./skia-build-win-gpu-arm64ec/skia-build-win-gpu-arm64ec.zip
            ./skia-build-mac-cpu/skia-build-mac-cpu.zip
            ./skia-build-mac-gpu/skia-build-mac-gpu.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
